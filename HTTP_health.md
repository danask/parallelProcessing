ì¢‹ì•„ìš”, ì •ë¦¬í•´ì„œ ë¬¸ì œ ìƒí™©ê³¼ ê°€ëŠ¥ì„±, í•´ê²° ë°©ì•ˆ ì¤‘ì‹¬ìœ¼ë¡œ ì•„ë˜ì™€ ê°™ì´ ì•ˆë‚´ë“œë¦´ê²Œìš”.

---

## âœ… í˜„ì¬ ìƒí™© ìš”ì•½

* **Spring Client â†’ ë‹¤ë¥¸ Spring ì„œë²„ API í˜¸ì¶œ**
* ì„œë²„ ì¬ì‹œì‘ ì§í›„ì—” ì •ìƒ ë™ì‘ â†’ ì¼ì • ì‹œê°„ í›„ **ê°„í—ì ìœ¼ë¡œ 500 ì˜¤ë¥˜ ë°œìƒ**
* `/ping` ì—”ë“œí¬ì¸íŠ¸ë¡œ **30ì´ˆë§ˆë‹¤ keep-alive í˜¸ì¶œ ì‹œ 401 OKë¡œ ì‘ë‹µ** ë°›ìŒ (ì¦‰, ì—°ê²° ìì²´ëŠ” ì‚´ì•„ ìˆìŒ)
* ê·¸ëŸ°ë° **ì‹¤ì œ API í˜¸ì¶œ ì‹œ 500 ì˜¤ë¥˜ ë°œìƒ**

---

## âœ… ì›ì¸ ê°€ëŠ¥ì„± ì •ë¦¬ (Client/Server ë¶„ë¦¬)

### ğŸŒ 1. ì„œë²„ ì¸¡ ë¬¸ì œ (API ì„œë²„)

| ê°€ëŠ¥ì„±                     | ì„¤ëª…                                                                | í™•ì¸ ë°©ë²•                                                                                           |
| ----------------------- | ----------------------------------------------------------------- | ----------------------------------------------------------------------------------------------- |
| A. ì¸ì¦ í† í° ìƒíƒœ ì´ìƒ          | `/ping`ì€ ì¸ì¦ ë¶ˆí•„ìš”í•˜ê±°ë‚˜ Refresh ì—†ì´ ì‘ë™, ë°˜ë©´ ì‹¤ APIëŠ” ì¸ì¦ í•„ìš” â†’ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë¹„ì •ìƒ ì²˜ë¦¬ | `/api` í˜¸ì¶œ ì‹œ Authorization í—¤ë” í™•ì¸, ì„œë²„ ë¡œê·¸ì—ì„œ ì¸ì¦ ê´€ë ¨ ì—ëŸ¬ (`Invalid token`, `Missing credentials` ë“±) í™•ì¸ |
| B. ì„¸ì…˜/ìºì‹œ/ThreadLocal ëˆ„ìˆ˜ | ì„œë²„ê°€ ì˜¤ë˜ ë™ì‘í•˜ë‹¤ ë³´ë©´ íŠ¹ì • ìƒíƒœë‚˜ ìºì‹œê°€ ì˜¤ì—¼ë˜ê±°ë‚˜ ì„¸ì…˜ timeout ë°œìƒ                     | ì„œë²„ ë¡œê·¸ì—ì„œ `NullPointerException`, `IllegalStateException` ë˜ëŠ” `cache`, `session` í‚¤ì›Œë“œ ê²€ìƒ‰            |
| C. ì„œë²„ ë‚´ë¶€ ìƒíƒœ ë¶ˆì•ˆì •         | ì—°ê²° í’€ ê³ ê°ˆ (DB ì»¤ë„¥ì…˜, HTTP Pool ë“±)                                     | DB ì»¤ë„¥ì…˜ í’€, thread pool, queue ìƒíƒœ ëª¨ë‹ˆí„°ë§ í•„ìš” (Actuator / Metrics / ë¡œê·¸)                               |
| D. íŠ¹ì • ìš”ì²­ íŒ¨í„´ì—ì„œ ì˜ˆì™¸        | ìš”ì²­ ë°”ë””, íŒŒë¼ë¯¸í„°, í—¤ë”ê°€ ì¼ë¶€ ìš”ì²­ì—ì„œ ë‹¬ë¼ì§€ëŠ” ê²½ìš°                                  | í´ë¼ì´ì–¸íŠ¸ ë¡œê·¸ì™€ ì„œë²„ ë¡œê·¸ë¥¼ `traceId` ë¡œ ë¬¶ì–´ì„œ ë¹„êµ ë¶„ì„ í•„ìš”                                                       |

---

### â˜ï¸ 2. í´ë¼ì´ì–¸íŠ¸(Spring Client) ì¸¡ ë¬¸ì œ

| ê°€ëŠ¥ì„±                        | ì„¤ëª…                                                | í™•ì¸ ë°©ë²•                                                             |
| -------------------------- | ------------------------------------------------- | ----------------------------------------------------------------- |
| A. ì¸ì¦ í—¤ë” ëˆ„ë½                | `/ping`ì€ í—¤ë” ì—†ì´ë„ ë˜ëŠ”ë°, ì‹¤ì œ APIëŠ” ì¸ì¦ í•„ìš” â†’ í† í° ê°±ì‹ /ì„¤ì •ì´ ëˆ„ë½ | ìš”ì²­ ë¡œê·¸ ì°ì–´ì„œ í—¤ë” ë‚´ìš© í™•ì¸                                                |
| B. HTTP Connection Pool ê³ ê°ˆ | WebClientê°€ ì»¤ë„¥ì…˜ì„ ì¬ì‚¬ìš©í•˜ì§€ ëª»í•˜ê³  ëŠê¸´ ì—°ê²°ì„ ê³„ì† ì‹œë„ â†’ 500 ê°€ëŠ¥   | `Connection reset`, `Premature close`, `ReactorNetty` ê´€ë ¨ ì—ëŸ¬ ë¡œê·¸ í™•ì¸ |
| C. WebClient ìƒíƒœ ì˜¤ë¥˜         | ì˜¤ë˜ëœ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ê±°ë‚˜ Reactor context ëˆ„ë½ ì‹œ ì˜¤ë¥˜ ë°œìƒ       | WebClient ì¬êµ¬ì„± í˜¹ì€ `.clone()` â†’ ìš”ì²­ ë§ˆë‹¤ fresh ìƒíƒœë¡œ ë§Œë“¤ê¸°                 |
| D. ì˜ëª»ëœ ìš”ì²­ (URI, ë°”ë”” ë“±)      | uri ì¡°ë¦½ ë¬¸ì œëŠ” í•´ê²°í–ˆë‹¤ê³  í–ˆì§€ë§Œ, ë°”ë”” ë˜ëŠ” íŒŒë¼ë¯¸í„° êµ¬ì¡°ëŠ” ì—¬ì „íˆ ë³€í•  ìˆ˜ ìˆìŒ  | ì‹¤ì œ 500 ë‚ ë¦¬ëŠ” ìš”ì²­ ì „ì²´ ë¡œê·¸ ê¸°ë¡ (Body í¬í•¨í•´ì„œ)                                |

---

## ğŸ”§ í•´ê²°ì±… ì •ë¦¬

### ğŸ”¹ í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ ê°€ëŠ¥í•œ ì¡°ì¹˜

1. **ìš”ì²­ ë¡œê·¸ ì „ëŸ‰ ê¸°ë¡ (debug level)**

   * URI, í—¤ë”, ë°”ë””, ì‘ë‹µ ì½”ë“œê¹Œì§€ **30ì´ˆ ì£¼ê¸°ë¡œ ì „ëŸ‰ ì¶œë ¥**
   * ìš”ì²­ ì‹¤íŒ¨ êµ¬ê°„ì—ì„œ ì–´ë–¤ ì°¨ì´ê°€ ìˆëŠ”ì§€ ëª…í™•íˆ ë¹„êµ

2. **WebClient ì»¤ë„¥ì…˜ í’€ ì„¤ì • ëª…í™•íˆ í•˜ê¸°**

   ```java
   HttpClient httpClient = HttpClient.create()
       .responseTimeout(Duration.ofSeconds(10))
       .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
       .doOnConnected(conn -> conn
           .addHandlerLast(new ReadTimeoutHandler(10))
           .addHandlerLast(new WriteTimeoutHandler(10)));

   WebClient webClient = WebClient.builder()
       .clientConnector(new ReactorClientHttpConnector(httpClient))
       .build();
   ```

3. **WebClientë¥¼ ìš”ì²­ë§ˆë‹¤ ìƒˆë¡œ clone í•´ì„œ ì‚¬ìš©**

   ```java
   webClient.mutate().build().get().uri(...).retrieve()...
   ```

4. **Pingì´ ì•„ë‹Œ ì‹¤ì œ API ìƒ˜í”Œë¡œ keep-alive**
   â†’ ì‹¤ì œ ì‚¬ìš©í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ (e.g. `/api/status`)ë¡œ dummy call
   â†’ ì´ê±¸ë¡œë„ 500ì´ ë‚˜ë©´ ì„œë²„ ì¸¡ ë¬¸ì œ í™•ì‹¤

---

### ğŸ”¹ ì„œë²„ ì¸¡ì—ì„œ ê°€ëŠ¥í•œ ì¡°ì¹˜

1. **API ì‘ë‹µì— ëŒ€í•œ `stacktrace` ë¡œê·¸ ì¶œë ¥**

   * Spring Boot 3.x ê¸°ì¤€ `error.includeStacktrace=always` ì„¤ì •í•˜ê³  actuator í†µí•´ í™•ì¸

2. **ìš”ì²­ `traceId` or `requestId` ë¡œ ì „ëŸ‰ ì¶”ì **

   * í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„ â†’ ë¡œê·¸ê¹Œì§€ ë™ì¼í•œ IDë¡œ ì¶”ì í•˜ì—¬ context ìœ ì§€

3. **Actuator + Prometheus ì„¤ì • í›„ í™, ì»¤ë„¥ì…˜ í’€, GC ìƒíƒœ ëª¨ë‹ˆí„°ë§**
   â†’ íŠ¹ì • ì‹œê°„ëŒ€ì˜ pool ê³ ê°ˆ ì—¬ë¶€ í™•ì¸

---

## âœ… í•µì‹¬ ì§„ë‹¨ í¬ì¸íŠ¸

* `/ping`ì€ í†µê³¼í•˜ì§€ë§Œ `ì‹¤ì œ API í˜¸ì¶œ`ì€ 500 â†’ **ì¸ì¦/ì„¸ì…˜/ìƒíƒœ ë¬¸ì œì¼ ê°€ëŠ¥ì„± ë†’ìŒ**
* ì¼ì • ì‹œê°„ í›„ ë°œìƒ â†’ **í’€ ê³ ê°ˆ / context ì˜¤ì—¼ / ì„¸ì…˜ ë§Œë£Œ / ì¸ì¦ ê°±ì‹  ì‹¤íŒ¨** ìœ í˜•ì´ ì˜ì‹¬ë¨
* ì„œë²„ ë¡œê·¸ì— 500 ì—ëŸ¬ ì›ì¸ì´ ë°˜ë“œì‹œ ë‚¨ìœ¼ë¯€ë¡œ **ì„œë²„ ì¸¡ ë¶„ì„ë„ ë°˜ë“œì‹œ í•„ìš”**
* **í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•´ê²°ë§Œìœ¼ë¡œ í•œê³„** ìˆìŒ â†’ ì„œë²„ì™€ í•¨ê»˜ ë³‘ë ¬ ë¶„ì„ í•„ìš”

---

í•„ìš”í•˜ë©´ `WebClient ì„¤ì •`, `Actuator metrics`, `ìš”ì²­ log í…œí”Œë¦¿`, `TraceID ì‚½ì… ë°©ë²•`ë„ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”.

-----

ì¢‹ìŠµë‹ˆë‹¤, ìƒí™©ì„ ì •ë¦¬í•´ ë³´ë©´:

---

### âœ… í˜„ì¬ ìƒí™© ìš”ì•½

* **Spring WebClient ì‚¬ìš© ì¤‘**
* `/ping`ì„ 30ì´ˆ ê°„ê²©ìœ¼ë¡œ í˜¸ì¶œí•˜ì—¬ ì„¸ì…˜ì´ **401 Unauthorized**ë¡œ ìœ ì§€ë˜ëŠ” ê²ƒì„ í™•ì¸í•¨ â†’ ì„¸ì…˜ì´ **ìœ íš¨**í•¨.
* ê·¸ëŸ°ë° ì •ì‘ **ì§„ì§œ API ìš”ì²­**ì„ ë³´ë‚¼ ë•ŒëŠ” **ê°„í—ì ìœ¼ë¡œ 500 Internal Server Error** ë°œìƒ.
* Spring ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ë©´ í•œë™ì•ˆ ì •ìƒ ì‘ë™í•˜ë‹¤ê°€ ì‹œê°„ì´ ì§€ë‚˜ë©´ 500ì´ ë‹¤ì‹œ ë°œìƒ.

---

## ğŸ” ê°€ëŠ¥í•œ ì›ì¸ ì •ë¦¬

### 1. **ì„œë²„ ì„¸ì…˜/í† í° ë¬¸ì œëŠ” ì•„ë‹˜**

* ì´ë¯¸ ping ìœ¼ë¡œ **ì„¸ì…˜ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ìŒì´ í™•ì¸**ëìŒ â†’ `401` ì•ˆ ë‚˜ì˜¤ê³  ìœ ì§€ë¨.

### 2. **ì„œë²„ ìª½ ë¦¬ì†ŒìŠ¤ ëˆ„ìˆ˜ / ëˆ„ì  ìƒíƒœ ë¬¸ì œ (ê°€ì¥ ìœ ë ¥)**

* ì¼ì • ì‹œê°„ ì´í›„ì—ë§Œ ë°œìƒ â†’ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜, connection pool ê³ ê°ˆ, ë²„í¼ overflow ê°€ëŠ¥ì„± ìˆìŒ.
* íŠ¹íˆ ì„œë²„ê°€ ë¡œë“œë¥¼ ìŒ“ì•„ê°€ë‹¤ê°€ ì¼ì • ì‹œì  ì´í›„ë¶€í„° 500 ì‘ë‹µ ì‹œì‘ë˜ëŠ” í˜„ìƒì€ **GC ë¯¸ë¹„, thread ëˆ„ë½, database connection ëˆ„ë½** ë“±ì„ ê°•í•˜ê²Œ ì˜ì‹¬í•¨.

### 3. **HTTP Keep-Alive or Connection Pool ë¬¸ì œ**

* í´ë¼ì´ì–¸íŠ¸(WebClient)ë‚˜ ì„œë²„ ì¸¡ì—ì„œ **keep-alive ì—°ê²°ì´ ì¬ì‚¬ìš©**ë˜ëŠ” ì¤‘ê°„ì— ë¬¸ì œê°€ ìƒê¹€ â†’ ì¬ì‚¬ìš©ëœ connection ì´ **ìœ íš¨í•˜ì§€ ì•ŠìŒ**ì—ë„ ë¶ˆêµ¬í•˜ê³  ê³„ì† ì“°ë ¤ë‹¤ê°€ ì˜¤ë¥˜ ë°œìƒ.
* ì¬ì‹œì‘í•˜ë©´ ì»¤ë„¥ì…˜ì´ ì´ˆê¸°í™”ë˜ì–´ ì ì‹œ ì •ìƒ ë™ì‘í•¨.

### 4. **Reverse Proxy (Nginx ë“±) Timeout / Buffer ì œí•œ**

* í´ë¼ì´ì–¸íŠ¸ëŠ” ìœ íš¨í•œ ìš”ì²­ì„ ë³´ë‚´ì§€ë§Œ ì¤‘ê°„ í”„ë¡ì‹œ(ì˜ˆ: Nginx) ë˜ëŠ” gateway ê°€ **buffer overflow**ë‚˜ timeout ë“±ì˜ ì´ìœ ë¡œ 500 ë°˜í™˜.
* ì„œë²„ ë¡œê·¸ì— ê¸°ë¡ì´ ì˜ ì•ˆ ë‚¨ì„ ìˆ˜ë„ ìˆìŒ.

### 5. **Server-side Internal Exception**

* ì„œë²„ API ë‚´ë¶€ì—ì„œ ìƒíƒœê°€ ê¼¬ì¸ ìƒíƒœì—ì„œ ì˜ˆì™¸ ë°œìƒ (ì˜ˆ: DB ì—°ê²° timeout, NullPointerException, etc.)
* ì¬ì‹œì‘í•˜ë©´ ë‚´ë¶€ ìƒíƒœ ì´ˆê¸°í™”ë˜ì–´ ì ì‹œ ì •ìƒí™”.

---

## ğŸ”§ í•´ê²°ì±… ì œì•ˆ

### ğŸ”¹ í´ë¼ì´ì–¸íŠ¸ ì¸¡ ëŒ€ì‘ (Spring WebClient)

| ì¡°ì¹˜                       | ì„¤ëª…                                                                          |
| ------------------------ | --------------------------------------------------------------------------- |
| âœ… Connection pool ì¬ì‚¬ìš© ì œí•œ | `WebClient`ê°€ ì˜¤ë˜ëœ ì»¤ë„¥ì…˜ì„ ê³„ì† ì¬ì‚¬ìš©í•˜ë©´ ë¬¸ì œê°€ ë  ìˆ˜ ìˆìŒ.<br>â†’ ë‹¤ìŒ ì„¤ì •ìœ¼ë¡œ ì—°ê²°ì„ ì¼ì • ì‹œê°„ ì§€ë‚˜ë©´ ëŠê²Œ ì„¤ì • |

```java
HttpClient httpClient = HttpClient.create()
    .responseTimeout(Duration.ofSeconds(10))
    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
    .doOnConnected(conn -> conn
        .addHandlerLast(new ReadTimeoutHandler(10))
        .addHandlerLast(new WriteTimeoutHandler(10)))
    .keepAlive(false);  // <== ì¤‘ìš”: keep-alive ë”

WebClient webClient = WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(httpClient))
    .build();
```

| ì¡°ì¹˜                       | ì„¤ëª…                                                                                                                                                      |
| ------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------- |
| âœ… ping ëŒ€ì‹  ì‹¤ì œ ìƒ˜í”Œ API call | `/ping`ì´ ì‹¤ì œë¡œ ì•„ë¬´ ë¦¬ì†ŒìŠ¤ë„ ì•ˆ ì¡ëŠ” ê²½ìš°, ë‚´ë¶€ ì„¸ì…˜ì´ë‚˜ ì»¤ë„¥ì…˜ ì‚¬ìš© ìƒíƒœë¥¼ í…ŒìŠ¤íŠ¸í•˜ê¸° ì–´ë µë‹¤.<br>â†’ ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ API ì™€ **ìœ ì‚¬í•œ êµ¬ì¡°**ë¥¼ ê°€ì§„ `/sampleQuery` ë‚˜ `/fakeSearch` ê°™ì€ API ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•´ë³´ëŠ” ê²Œ ì¢‹ìŒ. |

---

### ğŸ”¹ ì„œë²„ ì¸¡ ëŒ€ì‘

| ì¡°ì¹˜                                   | ì„¤ëª…                                                                                 |
| ------------------------------------ | ---------------------------------------------------------------------------------- |
| âœ… ë¡œê·¸ ìˆ˜ì¤€ ì˜¬ë¦¬ê¸°                          | `/ping`ì€ ë˜ëŠ”ë°, ì‹¤ì œ ìš”ì²­ì´ 500 ì´ ë‚˜ë©´, ì„œë²„ **ë‚´ë¶€ API ë¡œê·¸**ë‚˜ **ì˜ˆì™¸ ë¡œê·¸**ë¥¼ í™•ì¸í•´ì•¼ root cause ë¶„ì„ ê°€ëŠ¥. |
| âœ… Connection pool, DB pool ìƒíƒœ í™•ì¸     | DB ì»¤ë„¥ì…˜ì„ ì œëŒ€ë¡œ ë°˜ë‚©í•˜ì§€ ì•Šê±°ë‚˜, íŠ¹ì • ìƒíƒœì—ì„œ ê³„ì† ëˆ„ìˆ˜ë˜ë©´ ëˆ„ì ë˜ê³  ê²°êµ­ 500 ì—ëŸ¬ ìœ ë°œ.                           |
| âœ… APIì— ëŒ€í•œ `@Transactional`, ì—ëŸ¬ ìºì¹˜ í™•ì¸ | ë‚´ë¶€ APIì—ì„œ Exception ì´ë‚˜ NullPointerException ë“±ì˜ ì„œë²„ ì—ëŸ¬ê°€ ë‚  ê²½ìš° catch ì•ˆí•˜ë©´ 500 ìœ¼ë¡œ ì‘ë‹µë¨.    |

---

## â“ Clientë§Œìœ¼ë¡œ í•´ê²° ê°€ëŠ¥í•œê°€?

* ì™„ì „íˆëŠ” **ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤**.
* í´ë¼ì´ì–¸íŠ¸ ìª½ì—ì„œ ì»¤ë„¥ì…˜ ì¬ì„¤ì •, timeout ê´€ë¦¬, ping ë“±ìœ¼ë¡œ **ê°„ì ‘ì ìœ¼ë¡œ ì¦ìƒ ì™„í™”ëŠ” ê°€ëŠ¥**.
* ê·¸ëŸ¬ë‚˜ ì§„ì§œ ì›ì¸ì´ ì„œë²„ ë‚´ë¶€ ìì› ê³ ê°ˆì´ë¼ë©´ **ì„œë²„ ìˆ˜ì • ì—†ì´ëŠ” ê·¼ë³¸ í•´ê²°ì€ ì–´ë ¤ì›€**.

---

## ğŸ” ì¶”ì²œ ë””ë²„ê¹… íë¦„

1. **WebClient ë¡œê·¸ ë ˆë²¨**ì„ `DEBUG`ë¡œ ì˜¬ë ¤ì„œ 500 ì‘ë‹µ ë‚˜ì˜¬ ë•Œ request/response ì¶”ì 
2. ì„œë²„ì¸¡ access logì™€ error logë¥¼ 500 ì½”ë“œ ì¤‘ì‹¬ìœ¼ë¡œ í™•ì¸
3. ë¬¸ì œê°€ ë°œìƒí•œ ì‹œê°„ëŒ€ì˜ ì„œë²„ thread dump (heap dumpë„ ê°€ëŠ¥í•˜ë©´ ì¢‹ìŒ)
4. DB ìª½ connection ëˆ„ìˆ˜ í™•ì¸ (HikariCP ë“± pool ìƒíƒœ)
5. ì»¤ë„¥ì…˜ pool / thread pool / file descriptor ëˆ„ìˆ˜ í™•ì¸ (`lsof`, `netstat`, `jstack`, `jmap` í™œìš©)

---

ì›í•˜ì‹œë©´ `WebClient`ë¥¼ ì•ˆì •ì ìœ¼ë¡œ êµ¬ì„±í•˜ëŠ” ìƒ˜í”Œ ì½”ë“œ ì „ì²´ë„ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.


----
ì •ë¦¬í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

## âœ… í˜„ìƒ ìš”ì•½

* í´ë¼ì´ì–¸íŠ¸(Spring) ì„œë²„ì—ì„œ ë‹¤ë¥¸ Spring ì„œë²„ì— API ìš”ì²­.
* ì²˜ìŒì—” ì •ìƒ â†’ ì¼ì • ì‹œê°„ í›„ë¶€í„° **ê°„í—ì  500 ì—ëŸ¬ ë°œìƒ.**
* í´ë¼ì´ì–¸íŠ¸ ì„œë²„ë¥¼ ì¬ì‹œì‘í•˜ë©´ ë‹¤ì‹œ ì •ìƒ â†’ ì¼ì • ì‹œê°„ í›„ ì¬ë°œ.
* ìµœê·¼ì—ëŠ” URI ì¡°ë¦½ ë¬¸ì œëŠ” í•´ê²°ë˜ì—ˆê³ , ì´ì œ **500 ì˜¤ë¥˜ë§Œ í•´ê²° í•„ìš”.**

---

## ğŸ” ê°€ëŠ¥í•œ ì›ì¸ (ì •ë¦¬)

| ì›ì¸                              | ì„¤ëª…                                                         | í•´ê²° ì£¼ì²´            |
| ------------------------------- | ---------------------------------------------------------- | ---------------- |
| 1. **Connection Pool ê³ ê°ˆ / ëˆ„ìˆ˜**  | `WebClient` ë˜ëŠ” `RestTemplate`ì—ì„œ ì»¤ë„¥ì…˜ì´ ë‹«íˆì§€ ì•Šì•„ Poolì´ ê³ ê°ˆë  ìˆ˜ ìˆìŒ | Client ì¸¡         |
| 2. **Keep-Alive ì—°ê²° Idle Close** | ì„œë²„ê°€ idle ì»¤ë„¥ì…˜ì„ ì¼ì • ì‹œê°„ í›„ ê°•ì œë¡œ close. ê·¸ í›„ ë‹¤ì‹œ ì¬ì‚¬ìš©í•˜ë ¤ë‹¤ 500 ë°œìƒ      | Client or Server |
| 3. **ì„œë²„ ìª½ ë¦¬ì†ŒìŠ¤ ë¬¸ì œ**              | ì„œë²„ ì¸¡ì—ì„œ ìš”ì²­ì´ ë§ì•„ì§€ë©° GC, ìŠ¤ë ˆë“œ, DB ì—°ê²° ë“± ë¬¸ì œ ë°œìƒ â†’ 500 ë°˜í™˜            | Server           |
| 4. **ì›¹ì„œë²„ í”„ë¡ì‹œ(Nginx ë“±)**         | í”„ë¡ì‹œì—ì„œ idle ì»¤ë„¥ì…˜ íƒ€ì„ì•„ì›ƒ ì„¤ì •ì´ ì§§ìœ¼ë©´ ëŠê¹€                             | ì£¼ë¡œ Server        |
| 5. **ì—ëŸ¬ ì‘ë‹µì„ 500ìœ¼ë¡œ ë°˜í™˜í•˜ëŠ” ì½”ë“œ**     | ì‹¤ì œ ì—ëŸ¬ëŠ” 400, 401, 503 ë“±ì¸ë° ì¼ê´„ì ìœ¼ë¡œ 500ìœ¼ë¡œ ë³´ë‚´ëŠ” ê²½ìš°                | Server           |

---

## âœ… KeepAlive ëŒ€ì±…: `ping` ëŒ€ì‹  **ìƒ˜í”Œ API ë°˜ë³µ í˜¸ì¶œí•˜ë©´ ì–´ë–¨ê¹Œ?**

> âœ”ï¸ ê²°ë¡ : ë§¤ìš° ì¢‹ì€ ë°©ë²•ì¼ ìˆ˜ ìˆìŒ. ì´ìœ ëŠ” ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

| ë°©ì‹                             | ì¥ì                                           | ë‹¨ì                                    |
| ------------------------------ | ------------------------------------------- | ------------------------------------ |
| `/ping` ê°™ì€ dummy í˜¸ì¶œ            | ë‹¨ìˆœí•˜ì§€ë§Œ ì„œë²„ì—ì„œ íŠ¹ë³„í•œ ì²˜ë¦¬ê°€ ì—†ì–´ íš¨ê³¼ê°€ ì œí•œì ì¼ ìˆ˜ ìˆìŒ         | ì‹¤ì œ API ê²½ë¡œì™€ ë‹¬ë¼ì„œ ìºì‹œ ë˜ëŠ” ì—°ê²°ì— ì‹¤íš¨ì„±ì´ ë–¨ì–´ì§ˆ ìˆ˜ë„ |
| **ì‹¤ì œ API (ex. /users/1 ë“±) í˜¸ì¶œ** | ì»¤ë„¥ì…˜ reuse, ì¸ì¦, í”„ë¡ì‹œ ê²½ë¡œ ëª¨ë‘ ì‹¤ì œ í™˜ê²½ ê·¸ëŒ€ë¡œ ë™ì‘ í™•ì¸ ê°€ëŠ¥ | ë¦¬ì†ŒìŠ¤ë¥¼ ì¼ë¶€ ì‚¬ìš©í•˜ë¯€ë¡œ ë„ˆë¬´ ìì£¼ í˜¸ì¶œì€ X            |

> ğŸ’¡ ì¦‰, ì‹¤ì œ ì“°ëŠ” API ì¤‘ ë¶€ë‹´ ì ì€ read-only API í•˜ë‚˜ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œí•˜ëŠ” ê²Œ ê°€ì¥ ì‹¤ìš©ì ì…ë‹ˆë‹¤.

```java
@Scheduled(fixedDelay = 30_000)
public void keepConnectionAlive() {
    webClient.get()
        .uri("/health/readiness") // ë˜ëŠ” /users/1 ì²˜ëŸ¼ read-only API
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
}
```

---

## ğŸ§ª í•´ê²° ë°©ì•ˆ ìš”ì•½ (Client + Server ê´€ì )

### 1. **í´ë¼ì´ì–¸íŠ¸(Spring) ì¸¡ì—ì„œ í•  ìˆ˜ ìˆëŠ” í•´ê²°ì±…**

* âœ… `WebClient` ì¬ì‚¬ìš© (`WebClient.builder()` ì‚¬ìš©í•˜ì—¬ Bean ë“±ë¡)
* âœ… `keep-alive` ìœ ì§€ ìœ„í•œ ì‹¤ì œ API í˜¸ì¶œ (ìœ„ ì˜ˆì‹œ)
* âœ… TCP ì»¤ë„¥ì…˜ timeout, response timeout ëª…ì‹œ ì„¤ì •
* âœ… ì˜ˆì™¸ ë°œìƒ ì‹œ ì¬ì‹œë„ ë¡œì§ ì¶”ê°€ (`retryWhen`, `Resilience4j`)

### 2. **ì„œë²„(Spring) ì¸¡ í™•ì¸ í¬ì¸íŠ¸**

* âœ… `/actuator/health` ë“± readiness endpointê°€ ì •ìƒì¸ì§€
* âœ… ì„œë²„ ë¡œê·¸ì—ì„œ 500 ë°œìƒ ì‹œ stacktrace í™•ì¸
* âœ… timeout ì„¤ì •ì´ ì§§ì€ì§€ í™•ì¸ (application.yml, nginx ë“±)
* âœ… ì„œë²„ê°€ ë³´ë‚´ëŠ” `Connection: close` í—¤ë” í™•ì¸

---

## âœ… ë‹¤ìŒ ì•¡ì…˜ í”Œëœ ì œì•ˆ

1. í´ë¼ì´ì–¸íŠ¸ ìª½ `keep-alive` ìœ ì§€ìš©ìœ¼ë¡œ ì‹¤ì œ APIë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ í˜¸ì¶œ (30\~60ì´ˆ ê°„ê²©)
2. WebClient ì¸ìŠ¤í„´ìŠ¤ë¥¼ ë§¤ë²ˆ ë§Œë“¤ì§€ ë§ê³  **Beanìœ¼ë¡œ ì‹±ê¸€í„´ ì¬ì‚¬ìš©**
3. ì„œë²„ ìª½ ë¡œê·¸ì—ì„œ 500 ì—ëŸ¬ stacktrace ì¶”ì  â†’ ì›ì¸ ë” ì¢íˆê¸°
4. ì„œë²„ ì¸¡ actuator í™œì„±í™”í•´ì„œ `/actuator/metrics/http.server.errors` í™•ì¸
5. nginx, load balancer ìª½ timeout ì„¤ì • í™•ì¸ (idle timeout 60ì´ˆ ì´í•˜ì¸ì§€)

---

í•„ìš”í•˜ë©´ `tcpdump`, `actuator`, ë˜ëŠ” `Resilience4j` ì„¤ì • ì˜ˆì‹œë„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
ë” êµ¬ì²´ì ì¸ ë¡œê·¸ë‚˜ ì„¤ì • ê³µìœ  ì£¼ì‹œë©´ ë””ë²„ê¹…ë„ í•¨ê»˜ í•´ë“œë¦´ê²Œìš”.


----

ì¢‹ìŠµë‹ˆë‹¤. í˜„ì¬ ìƒí™©ì„ ìš”ì•½í•˜ê³ , ê°€ëŠ¥í•œ ì›ì¸ê³¼ í•´ê²°ì±…ì„ **í´ë¼ì´ì–¸íŠ¸(Spring WebClient)ì™€ ì„œë²„ ì–‘ì¸¡ ê´€ì **ì—ì„œ ì •ë¦¬í•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.

---

## âœ… í˜„ìƒ ìš”ì•½

* Spring WebClientë¡œ API ìš”ì²­ ì‹œ ê°„í—ì ìœ¼ë¡œ `500 Internal Server Error` ë°œìƒ
* í´ë¼ì´ì–¸íŠ¸(Spring ì„œë²„)ë¥¼ ì¬ì‹œì‘í•˜ë©´ í•œë™ì•ˆ ì •ìƒ ë™ì‘ â†’ ì¼ì • ì‹œê°„ í›„ ë‹¤ì‹œ `500`
* ì¼ì • ì‹œê°„ ìš”ì²­ì´ ì—†ì—ˆë‹¤ê°€ ë‹¤ì‹œ í˜¸ì¶œí•˜ë©´ ì—ëŸ¬ ë°œìƒ â†’ *idle connection ê´€ë ¨ ì¶”ì •*

---

## ğŸ” ê°€ëŠ¥í•œ ì›ì¸

### 1. **Idle Connectionìœ¼ë¡œ ì¸í•œ ì»¤ë„¥ì…˜ ì¢…ë£Œ**

* HTTP Keep-Alive ì—°ê²°ì€ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¬ì‚¬ìš©ì„ ì‹œë„í•˜ì§€ë§Œ, ì„œë²„ê°€ idle timeout í›„ ì—°ê²°ì„ ëŠì—ˆì„ ê²½ìš° â†’ ëŠê¸´ connectionì„ WebClientê°€ ì¬ì‚¬ìš©í•˜ë ¤ë‹¤ 500 ë°œìƒ
* **íŠ¹íˆ Netty ê¸°ë°˜ WebClientëŠ” ì»¤ë„¥ì…˜ ì¬ì‹œë„ ì—†ì´ ì˜ˆì™¸ë¡œ í„°ëœ¨ë¦¬ëŠ” ê²½ìš°ê°€ ë§ìŒ**

### 2. **Connection Poolì— Stale Connection ì¡´ì¬**

* WebClientëŠ” ì»¤ë„¥ì…˜ í’€ì—ì„œ stale(ì£½ì€) connectionì„ ê³¨ë¼ ì“¸ ìˆ˜ ìˆìŒ
* ì´ë¡œ ì¸í•´ ì„œë²„ ì…ì¥ì—ì„œ `socket closed` ë˜ëŠ” ì²˜ë¦¬ ì˜¤ë¥˜ â†’ 500 ë°˜í™˜ ê°€ëŠ¥ì„±

### 3. **ì„œë²„ì¸¡ Timeout ë˜ëŠ” Reverse Proxy ë¬¸ì œ**

* ì„œë²„ê°€ ì˜¤ë«ë™ì•ˆ idleì´ë˜ connectionì„ ëŠì–´ë²„ë¦¼ (e.g., Nginx `keepalive_timeout`, `idle_timeout`)
* í˜¹ì€ ì„œë²„ ë‚´ë¶€ thread pool exhaustion í›„ ì„ì˜ë¡œ 500 ë°œìƒ

---

## ğŸ›  í•´ê²° ë°©ë²•

### ğŸ“Œ í´ë¼ì´ì–¸íŠ¸(WebClient) ì¸¡ì—ì„œ ê°€ëŠ¥í•œ í•´ê²°ì±…

#### âœ… 1. **Connection TTL ë° Idle Timeout ì„¤ì •**

```java
HttpClient httpClient = HttpClient.create()
    .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
    .responseTimeout(Duration.ofSeconds(10))
    .doOnConnected(conn ->
        conn.addHandlerLast(new ReadTimeoutHandler(10))
            .addHandlerLast(new WriteTimeoutHandler(10)))
    .keepAlive(true)
    .resolver(DefaultAddressResolverGroup.INSTANCE)
    .tcpConfiguration(tcp ->
        tcp.option(ChannelOption.SO_KEEPALIVE, true))
    .secure() // TLS ì“´ë‹¤ë©´

    // ì¤‘ìš”: Idle timeoutê³¼ TTL ì„¤ì •
    .connectionProvider(ConnectionProvider.builder("custom")
        .maxIdleTime(Duration.ofSeconds(60)) // 60ì´ˆ ì´ìƒ idleì´ë©´ ë‹«ìŒ
        .maxLifeTime(Duration.ofMinutes(5))  // ì»¤ë„¥ì…˜ì€ ìµœëŒ€ 5ë¶„ í›„ ê°•ì œ ì¢…ë£Œ
        .evictInBackground(Duration.ofSeconds(30)) // ë°±ê·¸ë¼ìš´ë“œ evict ì£¼ê¸°
        .build());

WebClient webClient = WebClient.builder()
    .clientConnector(new ReactorClientHttpConnector(httpClient))
    .build();
```

#### âœ… 2. **Periodic Dummy Ping (Keep Alive)**

```java
@Scheduled(fixedDelay = 30_000)
public void keepAlive() {
    webClient.get()
        .uri("/ping")
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
}
```

* *ì£¼ì˜*: ì´ ë°©ì‹ì€ idle ì—°ê²°ì´ **ìš´ ì¢‹ê²Œ ì‚´ì•„ìˆë‹¤ë©´** ìœ ì§€ ê°€ëŠ¥í•˜ì§€ë§Œ, ì„œë²„ê°€ ì´ë¯¸ ëŠì€ ê²½ìš°ì—” ë¬´ì˜ë¯¸
* ë”°ë¼ì„œ ìœ„ `connectionProvider` ì„¤ì •ê³¼ **ë³‘í–‰**í•´ì•¼ í•¨

---

### ğŸ“Œ ì„œë²„ ì¸¡ì—ì„œ ê°€ëŠ¥í•œ ì¡°ì¹˜

#### âœ… 1. **Reverse Proxy ë˜ëŠ” Load Balancer ì„¤ì • í™•ì¸**

* Nginx ì˜ˆì‹œ:

```nginx
keepalive_timeout  75s;
proxy_read_timeout 90s;
```

* AWS ALB:

  * idle timeout ê¸°ë³¸ 60ì´ˆ â†’ ëŠ˜ë¦´ ìˆ˜ ìˆìŒ

#### âœ… 2. **ì„œë²„ ìì²´ì˜ Thread Pool, Connection ìˆ˜ ì¡°ì •**

* Tomcat, Undertow, Netty ì„¤ì • í™•ì¸
* ë§Œì•½ request threadê°€ ê³ ê°ˆë˜ì–´ 500ì´ ë°œìƒí•œë‹¤ë©´ ì„±ëŠ¥ ì„¤ì • ë¬¸ì œ

#### âœ… 3. **ì„œë²„ ë¡œê·¸ í™•ì¸**

* 500 ì—ëŸ¬ì˜ ì •í™•í•œ ë¡œê·¸ë‚˜ stack traceê°€ ì¤‘ìš”í•¨
  â†’ ì„œë²„ì—ì„œ ì–´ë–¤ ì˜ˆì™¸ë‚˜ ì¡°ê±´ìœ¼ë¡œ 500ì„ ì£¼ëŠ”ì§€ ë°˜ë“œì‹œ í™•ì¸

---

## ğŸ¯ ê²°ë¡ : ì–´ëŠ ìª½ì—ì„œ í•´ê²°í•´ì•¼ í•˜ë‚˜?

| êµ¬ë¶„                 | í•´ê²° ê°€ëŠ¥ ì—¬ë¶€  | ì£¼ìš” ëŒ€ì‘                                          |
| ------------------ | --------- | ---------------------------------------------- |
| âœ… í´ë¼ì´ì–¸íŠ¸(WebClient) | **ê°€ëŠ¥**    | connection pool TTL ì„¤ì •, stale connection evict |
| âœ… ì„œë²„ (API ì œê³µì)     | **ê°€ëŠ¥**    | idle timeout ëŠ˜ë¦¬ê¸°, reverse proxy ì„¤ì • í™•ì¸          |
| ğŸ” í˜‘ë ¥ í•„ìš”           | **ì–‘ìª½ ì¡°ì •** | idle ê´€ë¦¬ ì •ì±…ì„ ì„œë¡œ ë§ì¶°ì•¼ í•¨                           |

---

## ğŸ”š ì¶”ì²œ ìˆœì„œ

1. í´ë¼ì´ì–¸íŠ¸ ì¸¡ `ConnectionProvider` ì„¤ì •ìœ¼ë¡œ idle & TTL ê´€ë¦¬
2. ì„œë²„ì¸¡ `keepalive_timeout`, `proxy_read_timeout` í™•ì¸ ë° ë¡œê·¸ ë¶„ì„
3. í•„ìš”ì‹œ í´ë¼ì´ì–¸íŠ¸ ping ë³´ëƒ„ (`/ping`)ìœ¼ë¡œ ë³´ì™„

---

í•„ìš”í•˜ë©´ Netty ë˜ëŠ” Apache HttpClient ê¸°ë°˜ ì„¤ì •ë„ ë¹„êµí•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
Danielì´ ì‚¬ìš©í•˜ëŠ” ì •í™•í•œ WebClient ì„¤ì • ì½”ë“œ ê³µìœ í•´ì£¼ì‹œë©´ ë” ë§ì¶¤ ë¶„ì„ë„ ê°€ëŠ¥í•´ìš”.


-----

ì¢‹ì€ ì§ˆë¬¸ì´ì—ìš”. `@Scheduled`ë¡œ dummy pingì„ ë³´ë‚´ëŠ” ê±´ ì¼ì • ê°„ê²©ìœ¼ë¡œ ì»¤ë„¥ì…˜ì„ "í™œìš©"í•˜ë ¤ëŠ” ì˜ë„ì¸ë°, **WebClientê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì»¤ë„¥ì…˜ í’€ì„ ì–´ë–»ê²Œ ê´€ë¦¬í•˜ëŠëƒì— ë”°ë¼** ì‹¤ì œë¡œ idle ìƒíƒœì—ì„œ ì»¤ë„¥ì…˜ì´ ìœ ì§€ë ì§€ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆì–´ìš”. ì•„ë˜ì— ë³´ì¥ ì—¬ë¶€ì™€ ëŒ€ì•ˆì„ ì •ë¦¬í•´ ë“œë¦´ê²Œìš”:

---

### ğŸ” ì´ ì½”ë“œë§Œìœ¼ë¡œ idle ë°©ì§€ ë³´ì¥ë ê¹Œ?

```java
@Scheduled(fixedDelay = 30_000)
public void keepConnectionAlive() {
    webClient.get()
        .uri("/ping")
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
}
```

* ì´ ë°©ì‹ì€ ì¼ì • ì£¼ê¸°ë¡œ WebClientê°€ API í˜¸ì¶œì„ í•˜ë„ë¡ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— **`/ping` í˜¸ì¶œì´ ì„±ê³µí•˜ë©´ ì»¤ë„¥ì…˜ì€ ì¬ì‚¬ìš©(keep-alive) ìƒíƒœê°€ ë©ë‹ˆë‹¤.**
* í•˜ì§€ë§Œ ì¤‘ìš”í•œ ì ì€:

  * `WebClient`ê°€ **ì»¤ë„¥ì…˜ í’€ì„ ì¬ì‚¬ìš© ì¤‘ì¸ì§€ ì—¬ë¶€** (Connection: keep-aliveì¸ì§€, ì„œë²„ê°€ idle timeoutìœ¼ë¡œ ëŠì—ˆëŠ”ì§€ ë“±)
  * `subscribe()` ë°©ì‹ì´ **ë¹„ë™ê¸°ë¼ì„œ ì‹¤í–‰ ì‹œ ì˜ˆì™¸ê°€ ë‚´ë¶€ì—ì„œë§Œ í„°ì§€ê³  ë¡œê·¸ë¡œ ì•ˆ ë‚˜ì˜¬ ìˆ˜ ìˆìŒ**

---

### ğŸ§  ë³´ì¥ì´ ì•ˆ ë˜ëŠ” ì´ìœ 

1. **ì„œë²„ê°€ ì¼ì • ì‹œê°„ í›„ idle ì»¤ë„¥ì…˜ì„ ëŠì„ ìˆ˜ ìˆìŒ**

   * ì„œë²„(Nginx, API Gateway, Target ì„œë²„)ê°€ 60ì´ˆ, 90ì´ˆ idle ì»¤ë„¥ì…˜ì„ ëŠëŠ” ì„¤ì •ì´ë©´ 30ì´ˆ ê°„ê²©ì´ì–´ë„ race conditionìœ¼ë¡œ ëŠê¸¸ ìˆ˜ ìˆì–´ìš”.

2. **ì—°ê²° ì¬ì‚¬ìš©ì´ ì•ˆ ë˜ëŠ” ê²½ìš°**

   * `Connection: close` í—¤ë”ê°€ ìˆê±°ë‚˜, ì„œë²„ê°€ keep-aliveë¥¼ ì§€ì› ì•ˆ í•˜ë©´ í•­ìƒ ìƒˆë¡œìš´ ì»¤ë„¥ì…˜ì„ ë§Œë“¤ê³ , pingì€ ì˜ë¯¸ê°€ ì—†ìŒ.

3. **ì‘ë‹µ ì²˜ë¦¬ ì•ˆ í•˜ê³  subscribeë§Œ í•˜ë©´ ì»¤ë„¥ì…˜ í’€ì— ë°˜í™˜ ì•ˆ ë  ìˆ˜ë„ ìˆìŒ**

   * `bodyToMono(Void.class).subscribe()`ë¡œ ì‘ë‹µì„ ë¬´ì‹œí•˜ë©´ Netty ë ˆë²¨ì—ì„œ ì»¤ë„¥ì…˜ì´ í’€ì— ì˜ ë°˜í™˜ë˜ì§€ ì•Šê±°ë‚˜ ìƒíƒœê°€ ê¼¬ì¼ ìˆ˜ ìˆìŒ

---

### âœ… ë³´ì¥í•˜ë ¤ë©´ ì´ë ‡ê²Œ

1. **ì •ìƒì ì¸ ì‘ë‹µ ì†Œë¹„ + ì—ëŸ¬ ì²˜ë¦¬**

   ```java
   @Scheduled(fixedDelay = 30_000)
   public void keepConnectionAlive() {
       webClient.get()
           .uri("/ping")
           .retrieve()
           .toBodilessEntity()
           .doOnError(e -> log.warn("Ping failed: {}", e.getMessage()))
           .subscribe(response -> log.debug("Ping status: {}", response.getStatusCode()));
   }
   ```

2. **TCP-level keep-aliveë„ ì„¤ì •í•˜ëŠ” ê²ƒì´ ì•ˆì „**

   * Netty ê¸°ë°˜ WebClientì—ì„œ TCP Keep-Alive ì„¤ì •:

     ```java
     HttpClient httpClient = HttpClient.create()
         .tcpConfiguration(client ->
             client.option(ChannelOption.SO_KEEPALIVE, true)
         );
     ```

3. **Connection pool ì„¤ì • í™•ì¸**

   ```java
   HttpClient httpClient = HttpClient.create()
       .responseTimeout(Duration.ofSeconds(5))
       .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
       .doOnConnected(conn ->
           conn.addHandlerLast(new ReadTimeoutHandler(5))
               .addHandlerLast(new WriteTimeoutHandler(5)))
       .keepAlive(true); // ì‹¤ì œëŠ” TCP KeepAliveê°€ ì•„ë‹ˆë¼ Connection: keep-alive í—¤ë” ì˜ë¯¸

   WebClient webClient = WebClient.builder()
       .clientConnector(new ReactorClientHttpConnector(httpClient))
       .baseUrl("http://your-api")
       .build();
   ```

---

### ğŸ’¡ì¶”ê°€ íŒ

* **Wireshark / TCPDump**ë¡œ ì‹¤ì œ ì»¤ë„¥ì…˜ì´ ì¬ì‚¬ìš©ë˜ëŠ”ì§€ í™•ì¸ ê°€ëŠ¥
* ì„œë²„ê°€ ì»¤ë„¥ì…˜ì„ ëŠìœ¼ë©´, ë‹¤ìŒ í˜¸ì¶œì—ì„œ `Connection prematurely closed` ê°™ì€ ì—ëŸ¬ ë°œìƒ
* LoadBalancer ë˜ëŠ” API Gateway(Nginx ë“±)ê°€ ì¤‘ê°„ì— idle timeout ì„¤ì •ì„ ê°€ì§€ê³  ìˆìœ¼ë©´ **í´ë¼ì´ì–¸íŠ¸ ì¸¡ keepaliveë§Œìœ¼ë¡  ë°©ì§€ ë¶ˆê°€**

---

í•„ìš”í•˜ë‹¤ë©´ idle ì»¤ë„¥ì…˜ì´ ìƒê¸°ì§€ ì•Šê²Œ ì„œë²„ì™€ í´ë¼ì´ì–¸íŠ¸ ëª¨ë‘ì—ì„œ ì»¤ë„¥ì…˜ ìœ ì§€ ì „ëµì„ ë§ì¶°ì•¼ í•´ìš”. Danielì˜ í™˜ê²½(ì„œë²„ ì¢…ë¥˜, gateway ìœ ë¬´, cloud infra ë“±)ì„ ì•Œë ¤ì£¼ì‹œë©´ ë” ë§ì¶¤ìœ¼ë¡œ ë„ì™€ë“œë¦´ê²Œìš”.

---

"keep-alive"ë¥¼ ê³„ì† ë³´ë‚´ëŠ” ì ‘ê·¼ì€ ê²½ìš°ì— ë”°ë¼ íš¨ê³¼ì ì¼ ìˆ˜ ìˆì§€ë§Œ, ëª¨ë“  ìƒí™©ì— ì ì ˆí•œ í•´ê²°ì±…ì€ ì•„ë‹™ë‹ˆë‹¤. ì•„ë˜ì— ì´ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  í•´ê²°í•˜ê¸° ìœ„í•œ ë°©í–¥ì„ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.

---

## ğŸ’¡ ìƒí™© ìš”ì•½

* `/v1/query`ë¥¼ í˜¸ì¶œí•  ë•Œ ê°„í—ì ìœ¼ë¡œ `/v1/query/v1/query`ê°€ ë˜ëŠ” ë¬¸ì œ ë°œìƒ
* ì˜¤ë«ë™ì•ˆ ì ‘ì†ì´ ì—†ê±°ë‚˜ ì—°ì†ì ìœ¼ë¡œ í˜¸ì¶œí•  ê²½ìš° 500 ì—ëŸ¬ ë°œìƒ
* ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ connection ì´ ëŠê¸°ê±°ë‚˜ ë¬¸ì œê°€ ìƒê¸°ëŠ” ì •í™©
* WebClient/RestTemplate ì‚¬ìš©

---

## ğŸ§  ê°€ëŠ¥í•œ ì›ì¸

### 1. **Connection Poolì—ì„œ Idle Connectionì´ ì¬ì‚¬ìš©ë˜ë‹¤ ëŠê¸´ ê²½ìš°**

* ì„œë²„ë‚˜ í”„ë¡ì‹œ(Nginx, LB ë“±)ê°€ idle connectionì„ ì¼ì • ì‹œê°„ í›„ ëŠëŠ”ë°,
* í´ë¼ì´ì–¸íŠ¸ëŠ” ê·¸ ëŠê¸´ connectionì„ ë‹¤ì‹œ ì“°ë ¤ë‹¤ ì—ëŸ¬ ë°œìƒ

âœ… í•´ê²°ì±…:

* connection idle timeout ì„ ì§§ê²Œ ì„¤ì •í•˜ê±°ë‚˜
* connection validation (ì˜ˆ: stale connection check)ì„ ì‚¬ìš©í•˜ê±°ë‚˜
* ì£¼ê¸°ì ìœ¼ë¡œ ping/keep-alive ìš”ì²­ ë³´ë‚´ê¸°

---

### 2. **Client ì¸¡ì˜ URL ì¡°ë¦½ ë²„ê·¸**

* WebClientì—ì„œ base URLê³¼ ìš”ì²­ URLì„ ì˜ëª» ê²°í•©í•´ `v1/query/v1/query`ê°€ ë˜ëŠ” ê²½ìš°

```java
// baseUrl: http://api.example.com/v1/query
webClient.get()
    .uri("/v1/query") // -> http://api.example.com/v1/query/v1/query
```

âœ… í•´ê²°ì±…:

* `.baseUrl("http://host")` ë¡œ ì„¤ì •í•˜ê³  `.uri("/v1/query")`
* ë˜ëŠ” `.baseUrl("http://host/v1")` + `.uri("/query")` ë¡œ ì¼ê´€ì„± ìœ ì§€

---

### 3. **ì„œë²„ ì¸¡ Rate Limit / Thread Pool ê³ ê°ˆ**

* ì—°ì† í˜¸ì¶œ ì‹œ ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤(ìŠ¤ë ˆë“œ, DB connection ë“±)ê°€ ê³ ê°ˆë˜ì–´ 500 ì—ëŸ¬
* íŠ¹íˆ health check ê°€ ë§ìœ¼ë©´ ì„œë²„ ìì›ì„ ë‚­ë¹„í•  ìˆ˜ ìˆìŒ

âœ… í•´ê²°ì±…:

* ì„œë²„ì— ì ì ˆí•œ rate-limit, circuit breaker ì ìš©
* health check endpointëŠ” ìµœëŒ€í•œ lightweightí•˜ê²Œ ìœ ì§€
* 500 ë°œìƒ ì‹œ ì¬ì‹œë„(Retry) ì„¤ì • ê³ ë ¤

---

## âœ… Keep-Alive ì£¼ê¸°ì  ì „ì†¡? (Ping Strategy)

### ğŸ”¹ íš¨ê³¼ ìˆì„ ìˆ˜ ìˆëŠ” ê²½ìš°

* ì—°ê²°ì´ ìì£¼ ëŠê¸°ëŠ” ê²½ìš°, ì»¤ë„¥ì…˜ í’€ ë‚´ì—ì„œ keep-aliveë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ ì—°ê²° ì•ˆì •ì„± í–¥ìƒ

### ğŸ”¹ í•œê³„ ë° ì£¼ì˜ì 

* ë„ˆë¬´ ìì£¼ ë³´ë‚´ë©´ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„
* LBë‚˜ í”„ë¡ì‹œê°€ idle connectionì„ 60ì´ˆ ì´ë‚´ë¡œ kill í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ê¸° ë§ì¶”ê¸°
* ì‹¤ì œ API callì´ ì•„ë‹Œ dummy/ping callì´ì–´ì•¼ í•¨

```java
// ì˜ˆ: 30ì´ˆë§ˆë‹¤ dummy ping
@Scheduled(fixedDelay = 30_000)
public void keepConnectionAlive() {
    webClient.get()
        .uri("/ping")
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
}
```

---

## ğŸ›  í•¨ê»˜ ì“°ë©´ ì¢‹ì€ ì„¤ì •ë“¤

### ğŸ”¹ WebClient Timeout + Retry + Connection Pool

```java
@Bean
public WebClient webClient() {
    HttpClient httpClient = HttpClient.create()
        .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5_000)
        .responseTimeout(Duration.ofSeconds(5))
        .doOnConnected(conn -> conn
            .addHandlerLast(new ReadTimeoutHandler(5))
            .addHandlerLast(new WriteTimeoutHandler(5)))
        .keepAlive(true)
        .tcpConfiguration(client ->
            client.option(ChannelOption.SO_KEEPALIVE, true)
        )
        .metrics(true);

    return WebClient.builder()
        .clientConnector(new ReactorClientHttpConnector(httpClient))
        .baseUrl("http://your-api.com")
        .build();
}
```

---

## ğŸ”š ê²°ë¡ 

| ë¬¸ì œ                | ì›ì¸ ê°€ëŠ¥ì„±             | ì¡°ì¹˜                                   |
| ----------------- | ------------------ | ------------------------------------ |
| URL ì¤‘ë³µ            | URI ì„¤ì • ì˜¤ë¥˜          | `baseUrl`, `uri` í™•ì¸                  |
| ê°„í—ì  500           | ëŠê¸´ ì»¤ë„¥ì…˜ ì¬ì‚¬ìš©, ì„œë²„ ê³¼ë¶€í•˜ | ì»¤ë„¥ì…˜ í’€, keep-alive, retry, timeout ì„¤ì • |
| ì—°ì† í˜¸ì¶œ ì‹œ 500       | ì„œë²„ ë¦¬ì†ŒìŠ¤ ë¶€ì¡±          | Rate limit / ë°±ì˜¤í”„ / ì„œí‚·ë¸Œë ˆì´ì»¤            |
| keep-alive ì£¼ê¸°ì  í˜¸ì¶œ | Idle ë°©ì§€ ê°€ëŠ¥         | ì£¼ì˜í•´ì„œ ì ìš© (30\~60ì´ˆ)                    |

---

í•„ìš”í•˜ë©´ WebClient ì„¤ì •, ì„œí‚·ë¸Œë ˆì´ì»¤, ë˜ëŠ” ìƒíƒœ ì¶”ì  ëª¨ë‹ˆí„°ë§ ì„¤ì •ë„ ë„ì™€ë“œë¦´ê²Œìš”.


----

ê·¸ë ‡ë‹¤ë©´ ë¬¸ì œëŠ” ë‹¨ìˆœí•œ ì½”ë“œ ë²„ê·¸ê°€ ì•„ë‹ˆë¼ **ë™ì  í™˜ê²½ì—ì„œ URLì´ ì¤‘ë³µë˜ê±°ë‚˜ ì˜ëª» ì¡°ë¦½ë˜ëŠ” ì‹œì ì´ ì¡´ì¬í•œë‹¤**ëŠ” ëœ»ì…ë‹ˆë‹¤. ì¦‰, ë‹¤ìŒ ì¤‘ í•˜ë‚˜ í˜¹ì€ ë³µí•©ì  ì›ì¸ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

---

## âœ… í”íˆ ë°œìƒí•˜ëŠ” ìƒí™©ë³„ ì›ì¸ (í—¬ìŠ¤ì²´í¬ URLì´ `ëë‹¤ ì•ˆëë‹¤` ë˜ëŠ” `/v1/query/v1/query`ê°€ ê°€ë” ë‚˜ì˜¬ ë•Œ)

### 1. **ë™ì ìœ¼ë¡œ URL ì¡°ë¦½í•  ë•Œ ìŠ¬ë˜ì‹œ ìœ ë¬´ì— ë”°ë¼ ì¤‘ë³µ ê²½ë¡œ ë°œìƒ**

```java
String baseUrl = "https://api.com/v1/query"; // ìŠ¬ë˜ì‹œ ì—†ìŒ
String path = "/v1/query";                   // ìŠ¬ë˜ì‹œ ìˆìŒ

String fullUrl = baseUrl + path; // ê²°ê³¼: https://api.com/v1/query/v1/query (âŒ)
```

âœ… í•´ê²°: `UriComponentsBuilder`ë¥¼ ì‚¬ìš©í•´ì„œ ì•ˆì „í•˜ê²Œ ì¡°ë¦½

```java
String fullUrl = UriComponentsBuilder.fromHttpUrl(baseUrl)
    .path(path)
    .build()
    .toUriString();
```

---

### 2. **Spring `WebClient`ì˜ `baseUrl()` ì„¤ì •ê³¼ `.uri()`ê°€ ì¶©ëŒ**

| ì„¤ì •                                                           | í˜„ìƒ                           |
| ------------------------------------------------------------ | ---------------------------- |
| baseUrl: `https://api.com/v1/query` <br> `.uri("/v1/query")` | ìµœì¢… URLì´ `/v1/query/v1/query` |
| baseUrl: `https://api.com` <br> `.uri("/v1/query")`          | ì˜¬ë°”ë¥´ê²Œ ì‘ë™                      |

> ê·¸ëŸ°ë° `.uri("v1/query")` (ìŠ¬ë˜ì‹œ ì—†ìŒ)ìœ¼ë¡œ ì“¸ ê²½ìš°, baseUrlì— pathê°€ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë¶™ìŠµë‹ˆë‹¤ â†’ ì´ê²Œ "ëë‹¤ ì•ˆëë‹¤" í•˜ëŠ” ì›ì¸ì´ ë  ìˆ˜ ìˆìŒ.

âœ… í•´ê²°: `.uri()`ì— ì¸ìë¥¼ ëª…í™•í•˜ê²Œ ì£¼ê±°ë‚˜, baseUrlì„ ê³ ì •ëœ `/` ì—†ëŠ” ì£¼ì†Œë¡œ ì„¤ì •

---

### 3. **í—¬ìŠ¤ì²´í¬ ë¡œì§ì—ì„œ URL ìºì‹œë‚˜ ì¡°ê±´ ë¶„ê¸° ë²„ê·¸**

* URLì„ ìºì‹œì— ì €ì¥í•˜ê±°ë‚˜ ë™ì ìœ¼ë¡œ ìƒì„±í•œ í›„ reuseí•˜ëŠ” êµ¬ì¡°ì—ì„œ, ê°„í˜¹ ì¤‘ë³µëœ URLì´ ëˆ„ì ë¨
* ì˜ˆ:

  ```java
  // ì¡°ê±´ ë”°ë¼ baseUrlì´ ì„¤ì •ë¨
  String baseUrl = isInternal ? "http://internal/api" : "http://external/api/v1/query";
  ```

  ì´í›„ ë™ì¼í•˜ê²Œ `.uri("/v1/query")`ë¥¼ ë¶™ì—¬ë²„ë¦¼ â†’ ê²½ìš°ì— ë”°ë¼ ì¤‘ë³µ ë°œìƒ

âœ… í•´ê²°:

* ëª¨ë“  URL ì¡°í•©ë¶€ì— ë¡œê·¸ë¥¼ ì‹¬ì–´, ì‹¤ì œ URL ì¡°ë¦½ ì „í›„ ê°’ì„ í™•ì¸
* ì¡°ê±´ ë¶„ê¸°ë¥¼ ì—†ì• ê³ , baseUrl + pathë¥¼ ì¼ê´€ì„± ìˆê²Œ ì²˜ë¦¬

---

### 4. **ë¡œë“œ ë°¸ëŸ°ì„œ(LB) ë˜ëŠ” í”„ë¡ì‹œê°€ ê²½ë¡œë¥¼ ë³€ê²½**

* ì˜ˆ: AWS ALB, Istio, Nginx ë“±ì´ `/v1/query`ë¥¼ í”„ë¡ì‹œ ë‚´ë¶€ë¡œ ë„˜ê¸°ë©´ì„œ ë‹¤ì‹œ ë¶™ì´ëŠ” ì„¤ì •ì´ ì¡´ì¬
* ë˜ëŠ” íŠ¹ì • íƒ€ê²Ÿ ì¸ìŠ¤í„´ìŠ¤ë§Œ rewrite ë£°ì´ ì ìš©ë˜ì–´ URLì´ ë³€í˜•ë  ìˆ˜ë„ ìˆìŒ

âœ… í•´ê²°:

* LB, í”„ë¡ì‹œ, Istio ingress ë“±ì˜ ì„¤ì • í™•ì¸
* LB ëŒ€ìƒ ê·¸ë£¹ì— ë”°ë¼ ê²½ë¡œ ë³€ê²½ì´ ë°œìƒí•˜ëŠ”ì§€ ë¹„êµ

---

### 5. **WebClient ì»¤ìŠ¤í…€ í•„í„°ë‚˜ ê³µí†µ interceptorê°€ ì¤‘ë³µ ì¡°ì‘**

* ëª¨ë“  ìš”ì²­ì— prefixë¥¼ ìë™ìœ¼ë¡œ ë¶™ì´ëŠ” í•„í„°ê°€ ì¡´ì¬í•˜ê³ ,
* ì½”ë“œì—ì„œë„ ìˆ˜ë™ìœ¼ë¡œ `/v1/query`ë¥¼ ë¶™ì´ë©´ ì´ì¤‘ìœ¼ë¡œ ìƒê¹€

âœ… í™•ì¸:

* `WebClient.builder().filter(...)` ë‚´ ë¡œì§ ì ê²€
* interceptorë‚˜ logging filter ë“± ê³µí†µ ëª¨ë“ˆì—ì„œ URLì„ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ì§€

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ìš”ì•½

| ì²´í¬ í¬ì¸íŠ¸                         | ì„¤ëª…                                           |
| ------------------------------ | -------------------------------------------- |
| `baseUrl`ê³¼ `uri()`ì˜ path ì¶©ëŒ ì—¬ë¶€ | ë‘˜ ë‹¤ ê²½ë¡œ í¬í•¨ ì‹œ ì¤‘ë³µ ê°€ëŠ¥ì„±                           |
| ìŠ¬ë˜ì‹œ(`/`) ìœ ë¬´ì— ë”°ë¥¸ concat ë²„ê·¸      | `"a/" + "/b"` â†’ `a//b`, `"a" + "/b"` â†’ `a/b` |
| ì¡°ê±´ ë¶„ê¸° ë˜ëŠ” ìºì‹œëœ URLì˜ ì˜¤ë¥˜           | ë™ì ìœ¼ë¡œ ì¡°ë¦½í•œ URLì´ ìƒíƒœ ë”°ë¼ ì˜ëª»ë¨                      |
| í”„ë¡ì‹œ / LB ì„¤ì •                    | í”„ë¡ì‹œê°€ ë‚´ë¶€ì—ì„œ path ì¬ì‘ì„± ê°€ëŠ¥                        |
| WebClient filter/interceptor   | ê³µí†µ í•„í„°ê°€ URLì„ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ì§€                         |

---

## âœ… ëŒ€ì‘ ì „ëµ

1. **URL ì¡°ë¦½ ì‹œ ë¡œê·¸ ë‚¨ê¸°ê¸°** (ê²½ë¡œ/ìŠ¬ë˜ì‹œ í¬í•¨ ì—¬ë¶€ ëª…í™•íˆ)
2. `UriComponentsBuilder` ë“± ì•ˆì „í•œ ë°©ì‹ ì‚¬ìš©
3. ê³µí†µ baseUrlì€ `/` ì—†ì´ ì„¤ì •, `.uri()`ëŠ” í•­ìƒ `/v1/query`ì²˜ëŸ¼ ì ˆëŒ€ ê²½ë¡œ
4. ê°€ëŠ¥í•˜ë©´ baseUrlì— path ë¶™ì´ì§€ ë§ ê²ƒ (ê·¸ëŸ¼ `.uri("v1/query")`ì´ ì˜ë„ëŒ€ë¡œ ì‘ë™ ì•ˆí•¨)
5. WebClient í•„í„°ì™€ proxy ì„¤ì • ë¦¬ë·°

---

í•„ìš”í•˜ì‹œë©´ ë‹¤ìŒë„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”:

* `WebClient` + `Scheduler`ë¡œ ì£¼ê¸°ì  í—¬ìŠ¤ ì²´í¬ êµ¬ì„± ì½”ë“œ
* Istio/Nginx ë“± ingress ì„¤ì • í™•ì¸ ì˜ˆì œ
* ë¡œê·¸ í•„í„°ë¥¼ í†µí•´ URL ì¶”ì í•˜ëŠ” ê³µí†µ ì½”ë“œ

ì–´ëŠ ìª½ ì½”ë“œì—ì„œ ì¡°ë¦½ ì¤‘ì¸ì§€ (RestTemplate/WebClient ë“±) ì•Œë ¤ì£¼ì‹œë©´ ì •í™•íˆ ì§„ë‹¨í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

"keep-alive"ë¥¼ ê³„ì† ë³´ë‚´ëŠ” ì ‘ê·¼ì€ ê²½ìš°ì— ë”°ë¼ íš¨ê³¼ì ì¼ ìˆ˜ ìˆì§€ë§Œ, ëª¨ë“  ìƒí™©ì— ì ì ˆí•œ í•´ê²°ì±…ì€ ì•„ë‹™ë‹ˆë‹¤. ì•„ë˜ì— ì´ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  í•´ê²°í•˜ê¸° ìœ„í•œ ë°©í–¥ì„ ì •ë¦¬í•´ë“œë¦´ê²Œìš”.


---

ğŸ’¡ ìƒí™© ìš”ì•½

/v1/queryë¥¼ í˜¸ì¶œí•  ë•Œ ê°„í—ì ìœ¼ë¡œ /v1/query/v1/queryê°€ ë˜ëŠ” ë¬¸ì œ ë°œìƒ

ì˜¤ë«ë™ì•ˆ ì ‘ì†ì´ ì—†ê±°ë‚˜ ì—°ì†ì ìœ¼ë¡œ í˜¸ì¶œí•  ê²½ìš° 500 ì—ëŸ¬ ë°œìƒ

ì¼ì • ì‹œê°„ì´ ì§€ë‚˜ë©´ connection ì´ ëŠê¸°ê±°ë‚˜ ë¬¸ì œê°€ ìƒê¸°ëŠ” ì •í™©

WebClient/RestTemplate ì‚¬ìš©



---

ğŸ§  ê°€ëŠ¥í•œ ì›ì¸

1. Connection Poolì—ì„œ Idle Connectionì´ ì¬ì‚¬ìš©ë˜ë‹¤ ëŠê¸´ ê²½ìš°

ì„œë²„ë‚˜ í”„ë¡ì‹œ(Nginx, LB ë“±)ê°€ idle connectionì„ ì¼ì • ì‹œê°„ í›„ ëŠëŠ”ë°,

í´ë¼ì´ì–¸íŠ¸ëŠ” ê·¸ ëŠê¸´ connectionì„ ë‹¤ì‹œ ì“°ë ¤ë‹¤ ì—ëŸ¬ ë°œìƒ


âœ… í•´ê²°ì±…:

connection idle timeout ì„ ì§§ê²Œ ì„¤ì •í•˜ê±°ë‚˜

connection validation (ì˜ˆ: stale connection check)ì„ ì‚¬ìš©í•˜ê±°ë‚˜

ì£¼ê¸°ì ìœ¼ë¡œ ping/keep-alive ìš”ì²­ ë³´ë‚´ê¸°



---

2. Client ì¸¡ì˜ URL ì¡°ë¦½ ë²„ê·¸

WebClientì—ì„œ base URLê³¼ ìš”ì²­ URLì„ ì˜ëª» ê²°í•©í•´ v1/query/v1/queryê°€ ë˜ëŠ” ê²½ìš°


// baseUrl: http://api.example.com/v1/query
webClient.get()
    .uri("/v1/query") // -> http://api.example.com/v1/query/v1/query

âœ… í•´ê²°ì±…:

.baseUrl("http://host") ë¡œ ì„¤ì •í•˜ê³  .uri("/v1/query")

ë˜ëŠ” .baseUrl("http://host/v1") + .uri("/query") ë¡œ ì¼ê´€ì„± ìœ ì§€



---

3. ì„œë²„ ì¸¡ Rate Limit / Thread Pool ê³ ê°ˆ

ì—°ì† í˜¸ì¶œ ì‹œ ì„œë²„ì˜ ë¦¬ì†ŒìŠ¤(ìŠ¤ë ˆë“œ, DB connection ë“±)ê°€ ê³ ê°ˆë˜ì–´ 500 ì—ëŸ¬

íŠ¹íˆ health check ê°€ ë§ìœ¼ë©´ ì„œë²„ ìì›ì„ ë‚­ë¹„í•  ìˆ˜ ìˆìŒ


âœ… í•´ê²°ì±…:

ì„œë²„ì— ì ì ˆí•œ rate-limit, circuit breaker ì ìš©

health check endpointëŠ” ìµœëŒ€í•œ lightweightí•˜ê²Œ ìœ ì§€

500 ë°œìƒ ì‹œ ì¬ì‹œë„(Retry) ì„¤ì • ê³ ë ¤



---

âœ… Keep-Alive ì£¼ê¸°ì  ì „ì†¡? (Ping Strategy)

ğŸ”¹ íš¨ê³¼ ìˆì„ ìˆ˜ ìˆëŠ” ê²½ìš°

ì—°ê²°ì´ ìì£¼ ëŠê¸°ëŠ” ê²½ìš°, ì»¤ë„¥ì…˜ í’€ ë‚´ì—ì„œ keep-aliveë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ìœ ì§€í•˜ë©´ ì—°ê²° ì•ˆì •ì„± í–¥ìƒ


ğŸ”¹ í•œê³„ ë° ì£¼ì˜ì 

ë„ˆë¬´ ìì£¼ ë³´ë‚´ë©´ ë¦¬ì†ŒìŠ¤ ë‚­ë¹„

LBë‚˜ í”„ë¡ì‹œê°€ idle connectionì„ 60ì´ˆ ì´ë‚´ë¡œ kill í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì£¼ê¸° ë§ì¶”ê¸°

ì‹¤ì œ API callì´ ì•„ë‹Œ dummy/ping callì´ì–´ì•¼ í•¨

```java
// ì˜ˆ: 30ì´ˆë§ˆë‹¤ dummy ping
@Scheduled(fixedDelay = 30_000)
public void keepConnectionAlive() {
    webClient.get()
        .uri("/ping")
        .retrieve()
        .bodyToMono(Void.class)
        .subscribe();
}
```

---

ğŸ›  í•¨ê»˜ ì“°ë©´ ì¢‹ì€ ì„¤ì •ë“¤

ğŸ”¹ WebClient Timeout + Retry + Connection Pool

```java
@Bean
public WebClient webClient() {
    HttpClient httpClient = HttpClient.create()
        .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5_000)
        .responseTimeout(Duration.ofSeconds(5))
        .doOnConnected(conn -> conn
            .addHandlerLast(new ReadTimeoutHandler(5))
            .addHandlerLast(new WriteTimeoutHandler(5)))
        .keepAlive(true)
        .tcpConfiguration(client ->
            client.option(ChannelOption.SO_KEEPALIVE, true)
        )
        .metrics(true);

    return WebClient.builder()
        .clientConnector(new ReactorClientHttpConnector(httpClient))
        .baseUrl("http://your-api.com")
        .build();
}
```

---

ğŸ”š ê²°ë¡ 

ë¬¸ì œ	ì›ì¸ ê°€ëŠ¥ì„±	ì¡°ì¹˜

URL ì¤‘ë³µ	URI ì„¤ì • ì˜¤ë¥˜	baseUrl, uri í™•ì¸
ê°„í—ì  500	ëŠê¸´ ì»¤ë„¥ì…˜ ì¬ì‚¬ìš©, ì„œë²„ ê³¼ë¶€í•˜	ì»¤ë„¥ì…˜ í’€, keep-alive, retry, timeout ì„¤ì •
ì—°ì† í˜¸ì¶œ ì‹œ 500	ì„œë²„ ë¦¬ì†ŒìŠ¤ ë¶€ì¡±	Rate limit / ë°±ì˜¤í”„ / ì„œí‚·ë¸Œë ˆì´ì»¤
keep-alive ì£¼ê¸°ì  í˜¸ì¶œ	Idle ë°©ì§€ ê°€ëŠ¥	ì£¼ì˜í•´ì„œ ì ìš© (30~60ì´ˆ)



---

í•„ìš”í•˜ë©´ WebClient ì„¤ì •, ì„œí‚·ë¸Œë ˆì´ì»¤, ë˜ëŠ” ìƒíƒœ ì¶”ì  ëª¨ë‹ˆí„°ë§ ì„¤ì •ë„ ë„ì™€ë“œë¦´ê²Œìš”.




ê·¸ë ‡ë‹¤ë©´ ë¬¸ì œëŠ” ë‹¨ìˆœí•œ ì½”ë“œ ë²„ê·¸ê°€ ì•„ë‹ˆë¼ **ë™ì  í™˜ê²½ì—ì„œ URLì´ ì¤‘ë³µë˜ê±°ë‚˜ ì˜ëª» ì¡°ë¦½ë˜ëŠ” ì‹œì ì´ ì¡´ì¬í•œë‹¤**ëŠ” ëœ»ì…ë‹ˆë‹¤. ì¦‰, ë‹¤ìŒ ì¤‘ í•˜ë‚˜ í˜¹ì€ ë³µí•©ì  ì›ì¸ì´ ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

---

## âœ… í”íˆ ë°œìƒí•˜ëŠ” ìƒí™©ë³„ ì›ì¸ (í—¬ìŠ¤ì²´í¬ URLì´ `ëë‹¤ ì•ˆëë‹¤` ë˜ëŠ” `/v1/query/v1/query`ê°€ ê°€ë” ë‚˜ì˜¬ ë•Œ)

### 1. **ë™ì ìœ¼ë¡œ URL ì¡°ë¦½í•  ë•Œ ìŠ¬ë˜ì‹œ ìœ ë¬´ì— ë”°ë¼ ì¤‘ë³µ ê²½ë¡œ ë°œìƒ**

```java
String baseUrl = "https://api.com/v1/query"; // ìŠ¬ë˜ì‹œ ì—†ìŒ
String path = "/v1/query";                   // ìŠ¬ë˜ì‹œ ìˆìŒ

String fullUrl = baseUrl + path; // ê²°ê³¼: https://api.com/v1/query/v1/query (âŒ)
```

âœ… í•´ê²°: `UriComponentsBuilder`ë¥¼ ì‚¬ìš©í•´ì„œ ì•ˆì „í•˜ê²Œ ì¡°ë¦½

```java
String fullUrl = UriComponentsBuilder.fromHttpUrl(baseUrl)
    .path(path)
    .build()
    .toUriString();
```

---

### 2. **Spring `WebClient`ì˜ `baseUrl()` ì„¤ì •ê³¼ `.uri()`ê°€ ì¶©ëŒ**

| ì„¤ì •                                                           | í˜„ìƒ                           |
| ------------------------------------------------------------ | ---------------------------- |
| baseUrl: `https://api.com/v1/query` <br> `.uri("/v1/query")` | ìµœì¢… URLì´ `/v1/query/v1/query` |
| baseUrl: `https://api.com` <br> `.uri("/v1/query")`          | ì˜¬ë°”ë¥´ê²Œ ì‘ë™                      |

> ê·¸ëŸ°ë° `.uri("v1/query")` (ìŠ¬ë˜ì‹œ ì—†ìŒ)ìœ¼ë¡œ ì“¸ ê²½ìš°, baseUrlì— pathê°€ ìˆë‹¤ë©´ ê·¸ëŒ€ë¡œ ë¶™ìŠµë‹ˆë‹¤ â†’ ì´ê²Œ "ëë‹¤ ì•ˆëë‹¤" í•˜ëŠ” ì›ì¸ì´ ë  ìˆ˜ ìˆìŒ.

âœ… í•´ê²°: `.uri()`ì— ì¸ìë¥¼ ëª…í™•í•˜ê²Œ ì£¼ê±°ë‚˜, baseUrlì„ ê³ ì •ëœ `/` ì—†ëŠ” ì£¼ì†Œë¡œ ì„¤ì •

---

### 3. **í—¬ìŠ¤ì²´í¬ ë¡œì§ì—ì„œ URL ìºì‹œë‚˜ ì¡°ê±´ ë¶„ê¸° ë²„ê·¸**

* URLì„ ìºì‹œì— ì €ì¥í•˜ê±°ë‚˜ ë™ì ìœ¼ë¡œ ìƒì„±í•œ í›„ reuseí•˜ëŠ” êµ¬ì¡°ì—ì„œ, ê°„í˜¹ ì¤‘ë³µëœ URLì´ ëˆ„ì ë¨
* ì˜ˆ:

  ```java
  // ì¡°ê±´ ë”°ë¼ baseUrlì´ ì„¤ì •ë¨
  String baseUrl = isInternal ? "http://internal/api" : "http://external/api/v1/query";
  ```

  ì´í›„ ë™ì¼í•˜ê²Œ `.uri("/v1/query")`ë¥¼ ë¶™ì—¬ë²„ë¦¼ â†’ ê²½ìš°ì— ë”°ë¼ ì¤‘ë³µ ë°œìƒ

âœ… í•´ê²°:

* ëª¨ë“  URL ì¡°í•©ë¶€ì— ë¡œê·¸ë¥¼ ì‹¬ì–´, ì‹¤ì œ URL ì¡°ë¦½ ì „í›„ ê°’ì„ í™•ì¸
* ì¡°ê±´ ë¶„ê¸°ë¥¼ ì—†ì• ê³ , baseUrl + pathë¥¼ ì¼ê´€ì„± ìˆê²Œ ì²˜ë¦¬

---

### 4. **ë¡œë“œ ë°¸ëŸ°ì„œ(LB) ë˜ëŠ” í”„ë¡ì‹œê°€ ê²½ë¡œë¥¼ ë³€ê²½**

* ì˜ˆ: AWS ALB, Istio, Nginx ë“±ì´ `/v1/query`ë¥¼ í”„ë¡ì‹œ ë‚´ë¶€ë¡œ ë„˜ê¸°ë©´ì„œ ë‹¤ì‹œ ë¶™ì´ëŠ” ì„¤ì •ì´ ì¡´ì¬
* ë˜ëŠ” íŠ¹ì • íƒ€ê²Ÿ ì¸ìŠ¤í„´ìŠ¤ë§Œ rewrite ë£°ì´ ì ìš©ë˜ì–´ URLì´ ë³€í˜•ë  ìˆ˜ë„ ìˆìŒ

âœ… í•´ê²°:

* LB, í”„ë¡ì‹œ, Istio ingress ë“±ì˜ ì„¤ì • í™•ì¸
* LB ëŒ€ìƒ ê·¸ë£¹ì— ë”°ë¼ ê²½ë¡œ ë³€ê²½ì´ ë°œìƒí•˜ëŠ”ì§€ ë¹„êµ

---

### 5. **WebClient ì»¤ìŠ¤í…€ í•„í„°ë‚˜ ê³µí†µ interceptorê°€ ì¤‘ë³µ ì¡°ì‘**

* ëª¨ë“  ìš”ì²­ì— prefixë¥¼ ìë™ìœ¼ë¡œ ë¶™ì´ëŠ” í•„í„°ê°€ ì¡´ì¬í•˜ê³ ,
* ì½”ë“œì—ì„œë„ ìˆ˜ë™ìœ¼ë¡œ `/v1/query`ë¥¼ ë¶™ì´ë©´ ì´ì¤‘ìœ¼ë¡œ ìƒê¹€

âœ… í™•ì¸:

* `WebClient.builder().filter(...)` ë‚´ ë¡œì§ ì ê²€
* interceptorë‚˜ logging filter ë“± ê³µí†µ ëª¨ë“ˆì—ì„œ URLì„ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ì§€

---

## âœ… ì²´í¬ë¦¬ìŠ¤íŠ¸ ìš”ì•½

| ì²´í¬ í¬ì¸íŠ¸                         | ì„¤ëª…                                           |
| ------------------------------ | -------------------------------------------- |
| `baseUrl`ê³¼ `uri()`ì˜ path ì¶©ëŒ ì—¬ë¶€ | ë‘˜ ë‹¤ ê²½ë¡œ í¬í•¨ ì‹œ ì¤‘ë³µ ê°€ëŠ¥ì„±                           |
| ìŠ¬ë˜ì‹œ(`/`) ìœ ë¬´ì— ë”°ë¥¸ concat ë²„ê·¸      | `"a/" + "/b"` â†’ `a//b`, `"a" + "/b"` â†’ `a/b` |
| ì¡°ê±´ ë¶„ê¸° ë˜ëŠ” ìºì‹œëœ URLì˜ ì˜¤ë¥˜           | ë™ì ìœ¼ë¡œ ì¡°ë¦½í•œ URLì´ ìƒíƒœ ë”°ë¼ ì˜ëª»ë¨                      |
| í”„ë¡ì‹œ / LB ì„¤ì •                    | í”„ë¡ì‹œê°€ ë‚´ë¶€ì—ì„œ path ì¬ì‘ì„± ê°€ëŠ¥                        |
| WebClient filter/interceptor   | ê³µí†µ í•„í„°ê°€ URLì„ ìˆ˜ì •í•˜ì§€ ì•ŠëŠ”ì§€                         |

---

## âœ… ëŒ€ì‘ ì „ëµ

1. **URL ì¡°ë¦½ ì‹œ ë¡œê·¸ ë‚¨ê¸°ê¸°** (ê²½ë¡œ/ìŠ¬ë˜ì‹œ í¬í•¨ ì—¬ë¶€ ëª…í™•íˆ)
2. `UriComponentsBuilder` ë“± ì•ˆì „í•œ ë°©ì‹ ì‚¬ìš©
3. ê³µí†µ baseUrlì€ `/` ì—†ì´ ì„¤ì •, `.uri()`ëŠ” í•­ìƒ `/v1/query`ì²˜ëŸ¼ ì ˆëŒ€ ê²½ë¡œ
4. ê°€ëŠ¥í•˜ë©´ baseUrlì— path ë¶™ì´ì§€ ë§ ê²ƒ (ê·¸ëŸ¼ `.uri("v1/query")`ì´ ì˜ë„ëŒ€ë¡œ ì‘ë™ ì•ˆí•¨)
5. WebClient í•„í„°ì™€ proxy ì„¤ì • ë¦¬ë·°

---

í•„ìš”í•˜ì‹œë©´ ë‹¤ìŒë„ ë„ì™€ë“œë¦´ ìˆ˜ ìˆì–´ìš”:

* `WebClient` + `Scheduler`ë¡œ ì£¼ê¸°ì  í—¬ìŠ¤ ì²´í¬ êµ¬ì„± ì½”ë“œ
* Istio/Nginx ë“± ingress ì„¤ì • í™•ì¸ ì˜ˆì œ
* ë¡œê·¸ í•„í„°ë¥¼ í†µí•´ URL ì¶”ì í•˜ëŠ” ê³µí†µ ì½”ë“œ

ì–´ëŠ ìª½ ì½”ë“œì—ì„œ ì¡°ë¦½ ì¤‘ì¸ì§€ (RestTemplate/WebClient ë“±) ì•Œë ¤ì£¼ì‹œë©´ ì •í™•íˆ ì§„ë‹¨í•´ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

----
`/v1/query/v1/query`ì²˜ëŸ¼ **í—¬ìŠ¤ ì²´í¬ìš© API ê²½ë¡œê°€ ì¤‘ë³µ**ëœë‹¤ë©´, ê·¸ê±´ ê±°ì˜ 100% **ì˜ëª»ëœ base URL ë˜ëŠ” URI ê²°í•© ë¬¸ì œ**ì…ë‹ˆë‹¤. ì •í™•íˆ ì–´ë–¤ ë¶€ë¶„ì—ì„œ ë¬¸ì œê°€ ìƒê²¼ëŠ”ì§€ ì•„ë˜ì²˜ëŸ¼ ë¶„ì„í•´ë³¼ ìˆ˜ ìˆì–´ìš”.

---

## âœ… ë¬¸ì œ ìƒí™© ìš”ì•½

ì˜ˆìƒí–ˆë˜ URL:

```
https://api.service.com/v1/query
```

ì‹¤ì œ í˜¸ì¶œ URL:

```
https://api.service.com/v1/query/v1/query
```

---

## âœ… ì›ì¸ 1: **base URL ì˜ëª» ì„¤ì •**

### ì˜ˆ: `WebClient`ì—ì„œ `baseUrl`ì— pathë¥¼ í¬í•¨í–ˆëŠ”ë°, `uri()` í˜¸ì¶œ ì‹œ ì¤‘ë³µë¨

```java
WebClient client = WebClient.builder()
    .baseUrl("https://api.service.com/v1/query") // âŒ ì˜ëª»ëœ baseUrl
    .build();

client.get().uri("/v1/query").retrieve()  // ê²°ê³¼: https://api.service.com/v1/query/v1/query
```

### ğŸ”§ í•´ê²°:

baseUrlì—ëŠ” **hostë§Œ** ë„£ê³  pathëŠ” `uri()`ë¡œ ë¶„ë¦¬í•˜ì„¸ìš”.

```java
WebClient client = WebClient.builder()
    .baseUrl("https://api.service.com")  // âœ… ì˜¬ë°”ë¥¸ baseUrl
    .build();

client.get().uri("/v1/query").retrieve(); // ê²°ê³¼: https://api.service.com/v1/query
```

---

## âœ… ì›ì¸ 2: **RestTemplateì—ì„œ URL ì¡°í•© ì‹œ ìŠ¬ë˜ì‹œ ì¤‘ë³µ ë˜ëŠ” ëˆ„ë½**

### ì˜ˆ:

```java
String baseUrl = "https://api.service.com/v1/query";  // âŒ ê²½ë¡œ í¬í•¨ëœ baseUrl
String path = "/v1/query";

restTemplate.getForObject(baseUrl + path, String.class);  
// ê²°ê³¼: https://api.service.com/v1/query/v1/query
```

### ğŸ”§ í•´ê²°:

* baseUrlì—ëŠ” pathë¥¼ í¬í•¨í•˜ì§€ ë§ê³ 
* ê²½ë¡œëŠ” path ë³€ìˆ˜ë¡œ ë¶„ë¦¬í•˜ì„¸ìš”

```java
String baseUrl = "https://api.service.com";
String path = "/v1/query";

restTemplate.getForObject(baseUrl + path, String.class);  
// ê²°ê³¼: https://api.service.com/v1/query
```

---

## âœ… ì›ì¸ 3: **Spring Cloud Gatewayë‚˜ proxy ì„¤ì •ì—ì„œ path rewriting ë¬¸ì œ**

* `/v1/query`ë¥¼ ë‹¤ì‹œ ë‚´ë¶€ ë¼ìš°íŒ…ìœ¼ë¡œ ë¶™ì—¬ë²„ë¦¬ëŠ” ê²½ìš°ê°€ ìˆìŒ
* ì˜ˆ: `filters: - RewritePath=/v1/query,/v1/query/v1/query`

ì´ ê²½ìš°ëŠ” `application.yml`ì´ë‚˜ gateway ì„¤ì • í™•ì¸ í•„ìš”.

---

## âœ… ë””ë²„ê¹… íŒ

* ë¡œê·¸ì—ì„œ ìµœì¢… ìš”ì²­ URL í™•ì¸ (`DEBUG` ë ˆë²¨ì—ì„œ WebClient ë˜ëŠ” RestTemplate ë¡œê·¸ í™•ì¸)
* `WebClient`ëŠ” `.filter()`ì— ë¡œê¹… í•„í„° ì¶”ê°€í•´ì„œ ì¶”ì  ê°€ëŠ¥
* Postmanì´ë‚˜ cURLë¡œ ë™ì¼í•œ ìš”ì²­ ë³´ë‚´ì„œ ì‹¤ì œ í˜¸ì¶œ URL í™•ì¸

---

## âœ… ì •ë¦¬

| ì›ì¸                                 | í•´ê²° ë°©ë²•                                                 |
| ---------------------------------- | ----------------------------------------------------- |
| baseUrlì— pathê¹Œì§€ í¬í•¨ë¨                | baseUrlì—ëŠ” í˜¸ìŠ¤íŠ¸ê¹Œì§€ë§Œ ì„¤ì •í•˜ê³ , pathëŠ” `uri()`ì—ë§Œ ì‘ì„±             |
| URI ê²°í•© ì‹œ ìŠ¬ë˜ì‹œ ì¤‘ë³µ ë˜ëŠ” ëˆ„ë½              | `UriComponentsBuilder` ë˜ëŠ” `.join("/", ...)`ìœ¼ë¡œ ì•ˆì „í•˜ê²Œ ì¡°ë¦½ |
| Gatewayë‚˜ proxyê°€ pathë¥¼ ì¤‘ë³µìœ¼ë¡œ rewrite | Gateway í•„í„°ë‚˜ Nginx rewrite rule í™•ì¸                     |

---

í•„ìš”í•˜ë©´ WebClient, RestTemplate, ë˜ëŠ” Spring Cloud Gatewayì— ë§ëŠ” êµ¬ì²´ì ì¸ ì½”ë“œ ì˜ˆì œë„ ë°”ë¡œ ë“œë¦´ê²Œìš”. ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ í—¬ìŠ¤ ì²´í¬ë¥¼ êµ¬ì„±í–ˆëŠ”ì§€ ì•Œë ¤ì£¼ì‹œë©´ ë” ì •í™•íˆ ì§„ë‹¨í•´ë“œë¦´ ìˆ˜ ìˆì–´ìš”.


----

ì¢‹ìŠµë‹ˆë‹¤. ì•„ë˜ì— `WebClient`ì™€ `RestTemplate` ê°ê°ì— ëŒ€í•´ **retry, timeout, connection pool ì„¤ì •**ì„ ëª¨ë‘ ì •ë¦¬í•´ì„œ ì˜ˆì œì™€ í•¨ê»˜ ë“œë¦´ê²Œìš”. í”„ë¡œë•ì…˜ì— ë°”ë¡œ ì ìš© ê°€ëŠ¥í•œ í˜•íƒœë¡œ êµ¬ì„±í–ˆìŠµë‹ˆë‹¤.

---

## âœ… WebClient ì„¤ì • (Spring Boot 2.x\~3.x)

### 1. **Timeout + Connection Pool + Retry í¬í•¨**

```java
import io.netty.channel.ChannelOption;
import io.netty.handler.timeout.ReadTimeoutHandler;
import io.netty.handler.timeout.WriteTimeoutHandler;
import reactor.netty.http.client.HttpClient;
import reactor.util.retry.Retry;

import java.time.Duration;
import java.util.concurrent.TimeUnit;

@Bean
public WebClient webClient() {
    HttpClient httpClient = HttpClient.create()
        .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)
        .responseTimeout(Duration.ofSeconds(5))
        .doOnConnected(conn ->
            conn.addHandlerLast(new ReadTimeoutHandler(5, TimeUnit.SECONDS))
                .addHandlerLast(new WriteTimeoutHandler(5, TimeUnit.SECONDS))
        );

    return WebClient.builder()
        .clientConnector(new ReactorClientHttpConnector(httpClient))
        .baseUrl("https://target-api.com")
        .filter((request, next) -> next.exchange(request)
            .retryWhen(Retry.fixedDelay(3, Duration.ofMillis(500))) // ì¬ì‹œë„ 3íšŒ
        )
        .build();
}
```

> ğŸ”¸ ê¸°ë³¸ì ìœ¼ë¡œ WebClientëŠ” `reactor-netty`ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ, Netty ê¸°ë°˜ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.

---

## âœ… RestTemplate ì„¤ì • (Apache HttpClient ê¸°ë°˜)

### 1. **Timeout + Connection Pool ì„¤ì •**

```java
@Bean
public RestTemplate restTemplate() {
    int timeout = 5000;

    RequestConfig config = RequestConfig.custom()
        .setConnectTimeout(timeout)
        .setConnectionRequestTimeout(timeout)
        .setSocketTimeout(timeout)
        .build();

    PoolingHttpClientConnectionManager connectionManager = new PoolingHttpClientConnectionManager();
    connectionManager.setMaxTotal(100); // ì „ì²´ ì»¤ë„¥ì…˜ ìˆ˜
    connectionManager.setDefaultMaxPerRoute(20); // ëª©ì ì§€ë‹¹ ìµœëŒ€ ì»¤ë„¥ì…˜ ìˆ˜

    CloseableHttpClient httpClient = HttpClients.custom()
        .setConnectionManager(connectionManager)
        .setDefaultRequestConfig(config)
        .build();

    HttpComponentsClientHttpRequestFactory factory = new HttpComponentsClientHttpRequestFactory(httpClient);

    return new RestTemplate(factory);
}
```

---

### 2. **Retry ì²˜ë¦¬ (Spring Retry + RestTemplate)**

#### 2-1. ì˜ì¡´ì„± ì¶”ê°€ (Maven)

```xml
<dependency>
    <groupId>org.springframework.retry</groupId>
    <artifactId>spring-retry</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-aop</artifactId> <!-- @Retryable ì‘ë™ ìœ„í•´ í•„ìš” -->
</dependency>
```

#### 2-2. ì‚¬ìš© ì˜ˆì œ

```java
@EnableRetry  // Spring Boot main class ë˜ëŠ” config classì— ì„ ì–¸
@Configuration
public class RetryConfig {
}

@Service
public class MyService {

    private final RestTemplate restTemplate;

    public MyService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    @Retryable(
        value = { ResourceAccessException.class, HttpServerErrorException.class },
        maxAttempts = 3,
        backoff = @Backoff(delay = 1000) // 1ì´ˆ ë”œë ˆì´
    )
    public String callExternalApi() {
        ResponseEntity<String> response = restTemplate.getForEntity("https://target-api.com/resource", String.class);
        return response.getBody();
    }

    @Recover
    public String recover(Exception e) {
        return "Fallback result due to: " + e.getMessage();
    }
}
```

---

## âœ… ì°¸ê³ : íƒ€ì„ì•„ì›ƒ ì„¤ëª…

| ì„¤ì • ì¢…ë¥˜                             | ì„¤ëª…                        |
| --------------------------------- | ------------------------- |
| `connectTimeout`                  | ì„œë²„ì— ì—°ê²°í•˜ëŠ” ë° ê±¸ë¦¬ëŠ” ìµœëŒ€ ì‹œê°„      |
| `readTimeout` / `responseTimeout` | ì„œë²„ê°€ ì‘ë‹µí•˜ëŠ” ë°ê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„      |
| `connectionRequestTimeout`        | ì»¤ë„¥ì…˜ í’€ì—ì„œ ì»¤ë„¥ì…˜ì„ ì–»ê¸°ê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” ì‹œê°„ |

---

## âœ… ê²°ë¡ 

| í•­ëª©       | WebClient                                              | RestTemplate                                            |
| -------- | ------------------------------------------------------ | ------------------------------------------------------- |
| íƒ€ì„ì•„ì›ƒ ì„¤ì •  | `HttpClient.create().option(...).responseTimeout(...)` | `RequestConfig`                                         |
| ì»¤ë„¥ì…˜ í’€    | NettyëŠ” ìë™ ë˜ëŠ” `ConnectionProvider`ë¡œ ì„¤ì • ê°€ëŠ¥               | Apache HttpClientì˜ `PoolingHttpClientConnectionManager` |
| Retry ì§€ì› | `retryWhen(...)` ì§ì ‘ êµ¬í˜„                                 | `@Retryable` (Spring Retry ì‚¬ìš©)                          |

---

í•„ìš”í•˜ë‹¤ë©´ ë‹¤ìŒë„ ì•Œë ¤ë“œë¦´ ìˆ˜ ìˆì–´ìš”:

* Circuit Breaker (Resilience4j) ì„¤ì •
* WebClient ë¡œê¹… (`logging.level.reactor.netty` ë“±)
* WebClientì—ì„œ íƒ€ì„ì•„ì›ƒ, ì‹¤íŒ¨ ë¡œì§ ë³„ë„ fallback ì²˜ë¦¬

ì–´ë–¤ í™˜ê²½ (ì˜ˆ: ECS, EC2, ì¿ ë²„ë„¤í‹°ìŠ¤)ì¸ì§€ ë§ì”€í•´ ì£¼ì‹œë©´ ê·¸ì— ë§ê²Œ ì»¤ë„¥ì…˜ ìœ ì§€ ì „ëµë„ í•¨ê»˜ ì„¤ëª…ë“œë¦´ê²Œìš”.


